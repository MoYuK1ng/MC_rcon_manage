{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Dashboard" %} - MC RCON Manager{% endblock %}

{% block extra_css %}
<style>
    /* Modern Dashboard Styles - Inspired by Nezha/ServerStatus */
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin: -1rem -1rem 2rem -1rem;
        border-radius: 0 0 1rem 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .server-card {
        border: none;
        border-radius: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .server-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }
    
    .server-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.25rem;
        position: relative;
    }
    
    .server-status-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .server-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 0.25rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .server-address {
        font-size: 0.875rem;
        opacity: 0.9;
        font-family: 'Courier New', monospace;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        padding: 1.25rem;
        background: #f8fafc;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #667eea;
        display: block;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.25rem;
    }
    
    .player-list {
        padding: 1.25rem;
        min-height: 120px;
    }
    
    .player-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: #f1f5f9;
        border-radius: 0.5rem;
        margin: 0.25rem;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    .player-badge:hover {
        background: #e2e8f0;
        transform: scale(1.05);
    }
    
    .player-avatar {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .whitelist-section {
        padding: 1.25rem;
        background: white;
        border-top: 1px solid #e2e8f0;
    }
    
    .whitelist-form {
        display: flex;
        gap: 0.5rem;
    }
    
    .whitelist-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    .whitelist-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .whitelist-btn {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .whitelist-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .empty-state-icon {
        font-size: 4rem;
        opacity: 0.3;
        margin-bottom: 1rem;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f4f6;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
    <div class="container">
        <h1 class="mb-2">
            <i class="bi bi-speedometer2"></i>
            {% trans "Server Dashboard" %}
        </h1>
        <p class="mb-0 opacity-75">
            {% trans "Manage your Minecraft servers" %}
        </p>
    </div>
</div>

<div class="container">
    {% if servers %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
            {% for server in servers %}
                <div class="col">
                    <div class="server-card">
                        <!-- Server Header -->
                        <div class="server-header">
                            <div class="server-status-badge" title="{% trans 'Online' %}"></div>
                            <h3 class="server-title">
                                <i class="bi bi-hdd-network"></i>
                                {{ server.name }}
                            </h3>
                            <div class="server-address">
                                <i class="bi bi-globe2"></i>
                                {{ server.ip_address }}:{{ server.rcon_port }}
                            </div>
                        </div>
                        
                        <!-- Stats Grid -->
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value" id="player-count-{{ server.id }}">-</span>
                                <span class="stat-label">{% trans "Players" %}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                </span>
                                <span class="stat-label">{% trans "Status" %}</span>
                            </div>
                        </div>
                        
                        <!-- Player List -->
                        <div class="player-list">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-people-fill"></i>
                                {% trans "Online Players" %}
                            </h6>
                            <div 
                                id="player-list-{{ server.id }}"
                                hx-get="{% url 'player_list' server.id %}"
                                hx-trigger="load, every 30s"
                                hx-swap="innerHTML"
                            >
                                <div class="text-center text-muted">
                                    <div class="loading-spinner"></div>
                                    <small class="d-block mt-2">{% trans "Loading..." %}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Whitelist Section -->
                        <div class="whitelist-section">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-person-plus-fill"></i>
                                {% trans "Add to Whitelist" %}
                            </h6>
                            <form method="post" action="{% url 'whitelist_add' server.id %}" class="whitelist-form">
                                {% csrf_token %}
                                <input 
                                    type="text" 
                                    name="minecraft_username" 
                                    class="whitelist-input" 
                                    placeholder="{% trans 'Minecraft Username' %}"
                                    pattern="[a-zA-Z0-9_]{3,16}"
                                    title="{% trans '3-16 characters, letters, numbers, and underscores only' %}"
                                    required
                                >
                                <button type="submit" class="whitelist-btn">
                                    <i class="bi bi-plus-lg"></i>
                                    {% trans "Add" %}
                                </button>
                            </form>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle"></i>
                                {% trans "3-16 characters, alphanumeric and underscores only" %}
                            </small>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="bi bi-inbox"></i>
            </div>
            <h3 class="mb-3">{% trans "No Servers Available" %}</h3>
            <p class="text-muted mb-0">
                {% trans "You don't have access to any servers yet. Please contact your administrator to be added to a server group." %}
            </p>
        </div>
    {% endif %}
</div>

<script>
// Update player count dynamically
document.addEventListener('htmx:afterSwap', function(event) {
    const playerId = event.detail.target.id;
    if (playerId.startsWith('player-list-')) {
        const serverId = playerId.replace('player-list-', '');
        const playerBadges = event.detail.target.querySelectorAll('.player-badge');
        const countElement = document.getElementById('player-count-' + serverId);
        if (countElement) {
            countElement.textContent = playerBadges.length;
        }
    }
});
</script>
{% endblock %}
