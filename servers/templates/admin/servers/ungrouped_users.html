{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}{% trans "Ungrouped Users" %} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .user-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.2s;
    }
    
    .user-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #007bff;
    }
    
    .user-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .user-info {
        flex: 1;
    }
    
    .user-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    
    .user-meta {
        font-size: 13px;
        color: #666;
    }
    
    .user-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 13px;
    }
    
    .stat-icon {
        color: #6c757d;
    }
    
    .group-selector {
        margin-bottom: 15px;
    }
    
    .group-checkbox {
        display: inline-block;
        margin-right: 15px;
        margin-bottom: 8px;
    }
    
    .group-checkbox label {
        font-weight: normal;
        cursor: pointer;
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        transition: all 0.2s;
        display: inline-block;
    }
    
    .group-checkbox input[type="checkbox"]:checked + label {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .assign-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .assign-btn:hover {
        background: #218838;
    }
    
    .assign-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .stats-summary {
        background: #e7f3ff;
        border-left: 4px solid #007bff;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    
    .stats-summary h3 {
        margin: 0 0 5px 0;
        font-size: 16px;
        color: #004085;
    }
    
    .stats-summary p {
        margin: 0;
        font-size: 14px;
        color: #004085;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:auth_user_changelist' %}">{% trans 'Users' %}</a>
    &rsaquo; {% trans 'Ungrouped Users' %}
</div>
{% endblock %}

{% block content %}
<h1>{% trans "Ungrouped Users / 未分组用户" %}</h1>

<div class="stats-summary">
    <h3><i class="fas fa-info-circle"></i> {% trans "Quick Access Management" %}</h3>
    <p>
        {% blocktrans count counter=user_count %}
        Found {{ counter }} user without group assignment. Assign groups below to grant server access.
        {% plural %}
        Found {{ counter }} users without group assignments. Assign groups below to grant server access.
        {% endblocktrans %}
    </p>
    <p style="margin-top: 5px;">
        <strong>{% trans "找到" %} {{ user_count }} {% trans "个未分组用户。在下方分配组以授予服务器访问权限。" %}</strong>
    </p>
</div>

{% if ungrouped_users %}
    {% for user in ungrouped_users %}
    <div class="user-card">
        <form method="post" action="{% url 'admin:ungrouped_users' %}">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ user.id }}">
            
            <div class="user-header">
                <div class="user-info">
                    <div class="user-name">
                        <i class="fas fa-user"></i> {{ user.username }}
                    </div>
                    <div class="user-meta">
                        {% if user.email %}
                        <i class="fas fa-envelope"></i> {{ user.email }} &nbsp;|&nbsp;
                        {% endif %}
                        <i class="fas fa-calendar"></i> {% trans "Joined:" %} {{ user.date_joined|date:"Y-m-d H:i" }}
                        {% if user.last_login %}
                        &nbsp;|&nbsp; <i class="fas fa-sign-in-alt"></i> {% trans "Last login:" %} {{ user.last_login|date:"Y-m-d H:i" }}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="user-stats">
                <div class="stat-item">
                    <i class="fas fa-clipboard-list stat-icon"></i>
                    <span>{% trans "Whitelist Requests:" %} <strong>{{ user.whitelist_count }}</strong></span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-check-circle stat-icon" style="color: {% if user.is_active %}#28a745{% else %}#dc3545{% endif %};"></i>
                    <span>{% if user.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}</span>
                </div>
            </div>
            
            <div class="group-selector">
                <strong><i class="fas fa-users"></i> {% trans "Assign to Groups / 分配到组:" %}</strong>
                <div style="margin-top: 10px;">
                    {% if available_groups %}
                        {% for group in available_groups %}
                        <div class="group-checkbox">
                            <input type="checkbox" name="groups" value="{{ group.id }}" id="group_{{ user.id }}_{{ group.id }}" style="display: none;">
                            <label for="group_{{ user.id }}_{{ group.id }}">
                                <i class="fas fa-users"></i> {{ group.name }}
                            </label>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: #dc3545; margin: 10px 0;">
                            <i class="fas fa-exclamation-triangle"></i>
                            {% trans "No groups available. Please create groups first in the Groups section." %}
                        </p>
                    {% endif %}
                </div>
            </div>
            
            {% if available_groups %}
            <button type="submit" class="assign-btn">
                <i class="fas fa-check"></i> {% trans "Assign Selected Groups / 分配选中的组" %}
            </button>
            {% endif %}
        </form>
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <i class="fas fa-check-circle"></i>
        <h2>{% trans "All Users Are Grouped!" %}</h2>
        <p>{% trans "There are no users without group assignments." %}</p>
        <p>{% trans "所有用户都已分配到组！" %}</p>
    </div>
{% endif %}

{% endblock %}
