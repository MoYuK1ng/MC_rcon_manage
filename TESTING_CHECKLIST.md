# 测试清单 / Testing Checklist

## ⚠️ 已知问题和修复

### 1. ✅ 安装目录冲突 (已修复)
**问题**: 在 `/opt/mc` 运行脚本安装到 `/opt/mc_rcon` 时，删除目录导致当前目录失效
**修复**: 
- 添加安全检查，防止删除当前所在目录
- 添加确认提示
- 添加错误处理

### 2. ✅ Nginx 依赖移除 (已修复)
**问题**: 代码中残留 Nginx 相关操作
**修复**: 
- 删除所有 `systemctl restart nginx`
- 删除 Nginx 日志查看选项
- 删除 Nginx 状态检查

### 3. ✅ Admin CSS 失效 (已修复)
**问题**: 生产环境静态文件无法加载
**修复**: 
- 添加 WhiteNoise 中间件
- 配置静态文件存储

---

## 🧪 完整测试流程

### 测试环境准备
```bash
# 1. 准备干净的测试环境
docker run -it ubuntu:22.04 /bin/bash

# 2. 安装基础工具
apt update
apt install -y sudo wget curl git

# 3. 下载脚本
wget https://raw.githubusercontent.com/MoYuK1ng/MC_rcon_manage/main/manage.sh
chmod +x manage.sh
```

### 测试场景

#### 场景 1: 全新安装 (直接访问模式)
```bash
sudo bash manage.sh
# 选择语言: 2 (中文)
# 选择选项: 1 (全新安装)
# 安装路径: /opt/mc_rcon
# 端口: 8000
# 访问方式: 1 (直接访问)
```

**预期结果**:
- ✅ 成功克隆代码
- ✅ 创建虚拟环境
- ✅ 安装依赖
- ✅ 生成加密密钥
- ✅ 创建 .env 文件（格式正确，有换行）
- ✅ 初始化数据库
- ✅ 创建管理员账户
- ✅ 收集静态文件
- ✅ 启动服务
- ✅ 可以访问 http://IP:8000

#### 场景 2: 全新安装 (反向代理模式)
```bash
sudo bash manage.sh
# 选择语言: 2 (中文)
# 选择选项: 1 (全新安装)
# 安装路径: /opt/mc_rcon
# 端口: 47777
# 访问方式: 2 (反向代理)
# 域名: mc.example.com
# HTTPS: y
```

**预期结果**:
- ✅ .env 包含正确的 CSRF 配置
- ✅ CSRF_TRUSTED_ORIGINS=https://mc.example.com,http://localhost:47777,http://127.0.0.1:47777

#### 场景 3: 重复安装（目录已存在）
```bash
# 第一次安装
sudo bash manage.sh
# ... 完成安装

# 第二次安装到同一目录
sudo bash manage.sh
# 选择选项: 1 (全新安装)
# 安装路径: /opt/mc_rcon (已存在)
```

**预期结果**:
- ✅ 提示目录已存在
- ✅ 询问是否删除并重新安装
- ✅ 如果选择 n，取消安装
- ✅ 如果选择 y，删除旧目录并重新安装

#### 场景 4: 在安装目录内运行安装
```bash
cd /opt/mc_rcon
sudo bash manage.sh
# 选择选项: 1 (全新安装)
# 安装路径: /opt/mc_rcon
```

**预期结果**:
- ✅ 检测到在安装目录内
- ✅ 显示错误提示
- ✅ 要求用户先退出目录
- ✅ 不执行删除操作

#### 场景 5: 更新应用
```bash
cd /opt/mc_rcon
sudo bash manage.sh
# 选择选项: 2 (更新应用版本)
```

**预期结果**:
- ✅ 备份数据库
- ✅ 停止服务
- ✅ 拉取最新代码
- ✅ 更新依赖
- ✅ 运行迁移
- ✅ 收集静态文件
- ✅ 重启服务
- ✅ .env 文件不被修改

#### 场景 6: 服务管理
```bash
cd /opt/mc_rcon
sudo bash manage.sh

# 测试各个选项
# 3) 启动服务
# 4) 停止服务
# 5) 重启服务
# 6) 查看状态
# 7) 查看日志
```

**预期结果**:
- ✅ 启动/停止/重启正常工作
- ✅ 状态显示只有 mc-rcon 服务（无 Nginx）
- ✅ 日志选项只有应用日志（无 Nginx 日志）

#### 场景 7: 数据备份和恢复
```bash
cd /opt/mc_rcon
sudo bash manage.sh

# 8) 备份数据
# 9) 恢复数据
```

**预期结果**:
- ✅ 备份文件创建成功
- ✅ 恢复时停止服务
- ✅ 恢复后启动服务

#### 场景 8: 脚本自更新
```bash
cd /opt/mc_rcon
sudo bash manage.sh
# 11) 更新管理脚本
```

**预期结果**:
- ✅ 检查远程版本
- ✅ 显示版本对比
- ✅ 下载新脚本
- ✅ 备份旧脚本
- ✅ 替换并重启

#### 场景 9: 完全卸载
```bash
cd /opt/mc_rcon
sudo bash manage.sh
# 10) 完全卸载
# 输入: YES
```

**预期结果**:
- ✅ 停止服务
- ✅ 禁用服务
- ✅ 强制终止残留进程
- ✅ 删除 systemd 服务文件
- ✅ 可选备份数据库
- ✅ 删除项目目录
- ✅ 验证进程已终止

#### 场景 10: Admin 后台访问
```bash
# 访问 http://IP:PORT/admin
```

**预期结果**:
- ✅ CSS 正常加载
- ✅ 样式正确显示
- ✅ 可以登录
- ✅ 所有功能正常

#### 场景 11: CSRF 验证
```bash
# 通过域名访问应用
# 尝试登录或提交表单
```

**预期结果**:
- ✅ 不出现 403 CSRF 错误
- ✅ 表单提交成功
- ✅ 登录正常工作

---

## 🐛 Bug 修复记录

### v2.2.0 → v2.2.1

#### Bug #1: 安装目录冲突
- **发现时间**: 2024-11-28
- **严重程度**: 🔴 严重
- **影响**: 可能删除当前工作目录
- **修复**: 添加安全检查和确认提示

#### Bug #2: Nginx 残留代码
- **发现时间**: 2024-11-28
- **严重程度**: 🟡 中等
- **影响**: 显示不相关的服务信息
- **修复**: 删除所有 Nginx 相关代码

#### Bug #3: Admin CSS 失效
- **发现时间**: 2024-11-28
- **严重程度**: 🟡 中等
- **影响**: 后台样式无法加载
- **修复**: 添加 WhiteNoise 中间件

---

## ✅ 质量保证清单

### 代码质量
- [ ] 所有函数都有错误处理
- [ ] 所有用户输入都有验证
- [ ] 所有文件操作都有安全检查
- [ ] 所有服务操作都有状态检查

### 用户体验
- [ ] 所有提示信息清晰明确
- [ ] 所有错误信息有解决建议
- [ ] 所有操作都有确认提示（危险操作）
- [ ] 所有进度都有状态显示

### 安全性
- [ ] 不会意外删除重要文件
- [ ] 不会在错误目录执行操作
- [ ] 敏感信息不会泄露
- [ ] 权限检查正确

### 兼容性
- [ ] Ubuntu 20.04+ 测试通过
- [ ] Debian 11+ 测试通过
- [ ] 支持中英文界面
- [ ] 支持直接访问和反向代理模式

---

## 📝 测试报告模板

```markdown
## 测试报告

**测试日期**: YYYY-MM-DD
**测试人员**: 
**脚本版本**: v2.2.1
**测试环境**: Ubuntu 22.04

### 测试结果

| 场景 | 状态 | 备注 |
|------|------|------|
| 全新安装 (直接访问) | ✅ / ❌ | |
| 全新安装 (反向代理) | ✅ / ❌ | |
| 重复安装 | ✅ / ❌ | |
| 目录冲突检测 | ✅ / ❌ | |
| 更新应用 | ✅ / ❌ | |
| 服务管理 | ✅ / ❌ | |
| 数据备份恢复 | ✅ / ❌ | |
| 脚本自更新 | ✅ / ❌ | |
| 完全卸载 | ✅ / ❌ | |
| Admin 后台 | ✅ / ❌ | |
| CSRF 验证 | ✅ / ❌ | |

### 发现的问题

1. 
2. 
3. 

### 建议改进

1. 
2. 
3. 
```

---

## 🔄 持续改进

### 下一步计划
1. 添加自动化测试脚本
2. 添加健康检查功能
3. 添加性能监控
4. 改进错误恢复机制
5. 添加配置验证工具
