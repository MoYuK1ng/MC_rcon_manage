# 权限系统设计方案

## 🎯 设计目标
简化权限模型，参考宝塔面板、1Panel 等主流管理平台的设计思路。

## 📊 主流面板权限对比

### 宝塔面板
```
管理员 (Admin)
  └─ 完全权限，可以管理一切

普通用户 (User)
  └─ 只能访问被授权的网站/数据库
```

### 1Panel
```
管理员
  └─ 系统管理、用户管理、所有资源

操作员
  └─ 部分资源的查看和操作权限
```

### Portainer
```
Administrator
  └─ 完全控制

User
  └─ 只能访问被分配的资源
```

## ✅ 我们的新设计

### 角色定义

#### 1. 管理员 (Administrator)
- **标识**：`is_superuser = True`
- **权限**：
  - ✅ 访问 Django Admin 后台
  - ✅ 管理所有服务器
  - ✅ 管理所有用户
  - ✅ 审批白名单申请
  - ✅ 查看所有日志

#### 2. 普通用户 (User)
- **标识**：`is_superuser = False`
- **权限**：
  - ✅ 访问前台仪表板
  - ✅ 查看被分配的服务器
  - ✅ 对被分配的服务器执行 RCON 命令
  - ✅ 提交白名单申请
  - ❌ 不能访问 Admin 后台
  - ❌ 不能管理其他用户

### 简化后的用户字段

```python
User:
  - username (用户名)
  - password (密码)
  - is_superuser (是否管理员)
  - is_active (是否启用)
  - groups (所属组，用于服务器权限分配)
```

**移除的字段**：
- ~~is_staff~~ (不再使用，统一用 is_superuser)
- ~~email~~ (已移除)
- ~~first_name / last_name~~ (可选，不强制)

## 🎨 用户界面改进

### Admin 后台 - 用户列表

```
用户名          角色        状态      服务器权限
----------------------------------------------------
admin          管理员      启用      全部
user1          普通用户    启用      生存服务器
user2          普通用户    禁用      创造服务器
```

### 添加/编辑用户界面

```
基本信息
  用户名: [________]
  密码:   [________]
  
角色
  ( ) 普通用户 - 只能访问被分配的服务器
  (•) 管理员   - 拥有完全权限
  
状态
  [✓] 启用账户
  
服务器权限 (仅普通用户)
  [✓] 生存服务器
  [ ] 创造服务器
  [✓] 小游戏服务器
```

## 🔧 实现方案

### 1. 简化 User Admin

```python
class UserAdmin(BaseUserAdmin):
    list_display = ('username', 'role_display', 'is_active', 'server_count')
    list_filter = ('is_superuser', 'is_active')
    
    fieldsets = (
        ('基本信息', {
            'fields': ('username', 'password')
        }),
        ('角色和权限', {
            'fields': ('is_superuser', 'is_active', 'groups')
        }),
    )
    
    def role_display(self, obj):
        return '管理员' if obj.is_superuser else '普通用户'
    role_display.short_description = '角色'
    
    def server_count(self, obj):
        if obj.is_superuser:
            return '全部'
        return obj.groups.count()
    server_count.short_description = '服务器权限'
```

### 2. 改进密码修改脚本

```
当前用户:
============================================================
用户名             角色        状态      服务器权限
------------------------------------------------------------
admin             管理员      启用      全部
user1             普通用户    启用      2个服务器
user2             普通用户    禁用      1个服务器
============================================================
```

### 3. 前台仪表板

**管理员视图**：
```
我的服务器 (全部)
  📦 生存服务器    在线: 5/20
  📦 创造服务器    在线: 3/10
  📦 小游戏服务器  在线: 0/50
```

**普通用户视图**：
```
我的服务器 (2个)
  📦 生存服务器    在线: 5/20
  📦 小游戏服务器  在线: 0/50
  
  ℹ️ 如需访问更多服务器，请联系管理员
```

## 📝 迁移步骤

1. 更新 User Admin 配置
2. 更新密码修改脚本显示
3. 更新前台仪表板逻辑
4. 更新文档和帮助信息

## 🎯 用户体验改进

### 之前（混乱）
```
- is_staff: 工作人员？什么意思？
- is_superuser: 超级用户？和工作人员有什么区别？
- 需要同时设置两个才能访问后台？
```

### 之后（清晰）
```
- 管理员：完全权限，可以管理一切
- 普通用户：只能访问被分配的服务器
- 一目了然，不会混淆
```

## ✅ 优势

1. **简单直观**：只有管理员和普通用户两种角色
2. **易于理解**：不需要理解 Django 的 staff/superuser 概念
3. **符合习惯**：和主流面板的设计一致
4. **减少错误**：不会因为权限设置错误导致无法访问

## 🚀 下一步

1. 实现新的 User Admin
2. 更新密码修改脚本
3. 添加角色说明文档
4. 测试所有权限场景
